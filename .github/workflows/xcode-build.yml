name: Xcode Build & Test

on:
  workflow_call:
    inputs:
      scheme:
        description: 'Xcode scheme to build'
        type: string
        required: true
      project-path:
        description: 'Path to .xcodeproj or .xcworkspace'
        type: string
        default: '.'
      platform:
        description: 'Destination platform'
        type: string
        default: 'iOS Simulator'
      os-version:
        description: 'Simulator OS version'
        type: string
        default: 'latest'
      device:
        description: 'Simulator device'
        type: string
        default: 'iPhone 16'
      xcode-version:
        description: 'Xcode version to select'
        type: string
        default: 'latest-stable'

jobs:
  build:
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ${{ inputs.project-path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ inputs.xcode-version }}

      - name: Build
        run: |
          xcodebuild build \
            -scheme "${{ inputs.scheme }}" \
            -destination "platform=${{ inputs.platform }},OS=${{ inputs.os-version }},name=${{ inputs.device }}" \
            -resultBundlePath build-result \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Test
        run: |
          xcodebuild test \
            -scheme "${{ inputs.scheme }}" \
            -destination "platform=${{ inputs.platform }},OS=${{ inputs.os-version }},name=${{ inputs.device }}" \
            -resultBundlePath test-result \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcresult
          path: |
            ${{ inputs.project-path }}/build-result.xcresult
            ${{ inputs.project-path }}/test-result.xcresult
          if-no-files-found: ignore
