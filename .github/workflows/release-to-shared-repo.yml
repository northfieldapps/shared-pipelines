name: Publish to shared releases repo

on:
  workflow_call:
    inputs:
      tag:
        description: 'Git tag for the release (e.g. v1.2.3). Defaults to the triggering ref name.'
        type: string
        default: ''
      app-name:
        description: 'Application or component name. Used in the release title and to namespace the tag in northfieldapps/releases (e.g. "my-app").'
        type: string
        required: true
      release-notes:
        description: 'Release notes body text (inline). Takes priority over release-notes-file.'
        type: string
        default: ''
      artifact-path:
        description: 'Local path where artifacts are located or will be downloaded to.'
        type: string
        default: 'dist/'
    secrets:
      PUBLIC_RELEASE_PAT:
        description: 'PAT with write access to northfieldapps/releases.'
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Download consolidated artifacts
        uses: actions/download-artifact@v4
        with:
          name: all-platforms
          path: release-artifacts/

      - name: Publish to northfieldapps/releases
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASE_PAT }}
          RELEASE_NOTES: ${{ inputs.release-notes }}
        run: |
          TAG="${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}"
          APP_NAME="${{ inputs.app-name }}"
          APP_SLUG=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
          TITLE="$APP_NAME $TAG Release"
          RELEASE_NOTES="${{ inputs.release-notes }}"

          # Resolve release notes source
          if [ -n "$RELEASE_NOTES" ]; then
            printf '%s' "$RELEASE_NOTES" > /tmp/release-notes.md
            NOTES_FLAG="--notes-file /tmp/release-notes.md"
          else
            NOTES_FLAG="--generate-notes"
          fi

          # Collect artifact files to upload
          ARTIFACTS=(release-artifacts/*)

          gh release create "$APP_SLUG-$TAG" \
            --repo northfieldapps/releases \
            --title "$TITLE" \
            $NOTES_FLAG \
            "${ARTIFACTS[@]}"
