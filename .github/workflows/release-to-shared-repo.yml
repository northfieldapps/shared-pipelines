name: Publish to shared releases repo

on:
  workflow_call:
    inputs:
      tag:
        description: 'Git tag for the release (e.g. v1.2.3). Defaults to the triggering ref name.'
        type: string
        default: ''
      app-name:
        description: 'Application or component name. Used in the release title and to namespace the tag in northfieldapps/releases (e.g. "my-app").'
        type: string
        required: true
      release-title:
        description: 'Full release title. Overrides the auto-generated "<app-name> <tag>" title.'
        type: string
        default: ''
      release-notes:
        description: 'Release notes body text (inline). Takes priority over release-notes-file.'
        type: string
        default: ''
      release-notes-file:
        description: 'Path to a Markdown file with release notes (used when release-notes is empty). Falls back to --generate-notes if the file does not exist.'
        type: string
        default: 'RELEASE_NOTES.md'
      artifact-name:
        description: 'Name of the artifact to download from a prior workflow job.'
        type: string
        default: ''
      artifact-path:
        description: 'Local path where artifacts are located or will be downloaded to.'
        type: string
        default: 'dist/'
      prerelease:
        description: 'Mark the release as a pre-release.'
        type: boolean
        default: false
      draft:
        description: 'Create the release as a draft.'
        type: boolean
        default: false
    secrets:
      PUBLIC_RELEASE_PAT:
        description: 'PAT with write access to northfieldapps/releases.'
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Download artifacts
        if: inputs.artifact-name != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}

      - name: Resolve release metadata
        id: meta
        run: |
          TAG="${{ inputs.tag }}"
          [ -z "$TAG" ] && TAG="${GITHUB_REF_NAME}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "shared-tag=${{ inputs.app-name }}-$TAG" >> "$GITHUB_OUTPUT"

          TITLE="${{ inputs.release-title }}"
          [ -z "$TITLE" ] && TITLE="${{ inputs.app-name }} $TAG"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

      - name: Publish to northfieldapps/releases
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASE_PAT }}
          RELEASE_NOTES: ${{ inputs.release-notes }}
        run: |
          TAG="${{ steps.meta.outputs.shared-tag }}"
          TITLE="${{ steps.meta.outputs.title }}"

          # Resolve release notes source
          if [ -n "$RELEASE_NOTES" ]; then
            printf '%s' "$RELEASE_NOTES" > /tmp/release-notes.md
            NOTES_FLAG="--notes-file /tmp/release-notes.md"
          elif [ -f "${{ inputs.release-notes-file }}" ]; then
            NOTES_FLAG="--notes-file ${{ inputs.release-notes-file }}"
          else
            NOTES_FLAG="--generate-notes"
          fi

          # Optional flags
          EXTRA_FLAGS=()
          [ "${{ inputs.prerelease }}" = "true" ] && EXTRA_FLAGS+=(--prerelease)
          [ "${{ inputs.draft }}" = "true" ] && EXTRA_FLAGS+=(--draft)

          # Collect artifact files to upload
          ARTIFACTS=()
          if [ -d "${{ inputs.artifact-path }}" ]; then
            while IFS= read -r -d '' f; do
              ARTIFACTS+=("$f")
            done < <(find "${{ inputs.artifact-path }}" -type f -print0)
          fi

          gh release create "$TAG" \
            --repo northfieldapps/releases \
            --title "$TITLE" \
            $NOTES_FLAG \
            "${EXTRA_FLAGS[@]}" \
            "${ARTIFACTS[@]}"
